(()=>{function Re(){let[h,W]=React.useState(null),[q,j]=React.useState(null),[H,J]=React.useState(null),[K,x]=React.useState(""),[B,Z]=React.useState(!1),[E,T]=React.useState(!1),[z,M]=React.useState(null),[U,ee]=React.useState(!1),[f,P]=React.useState(""),$=React.useRef(null),G=React.useRef(null),O=React.useRef(null),re=React.useCallback(()=>window.ort&&window.ort.InferenceSession?Promise.resolve():new Promise((t,e)=>{let o=Date.now();(function i(){if(window.ort&&window.ort.InferenceSession)return t();if(Date.now()-o>15e3)return e(new Error("ONNX Runtime not loaded"));setTimeout(i,100)})()}),[]),ce=t=>{let e=t.target.files?.[0];W(e||null),J(null),x(""),j(e?URL.createObjectURL(e):null),T(!1),M(null)},le=async()=>{if(h){x(""),ee(!0),P("uploading");try{setTimeout(()=>P("processing"),1e3);let t=new FormData;t.append("image",h);let e=await fetch("/api/upload",{method:"POST",body:t});if(!e.ok){try{let n=await e.json();x(n?.error+(n?.details?`: ${n.details}`:""))}catch{let a=await e.text();x(a||"Upload failed")}return}P("generating"),setTimeout(()=>P("finalizing"),500);let o=await e.json();J(o);let i=()=>{if($.current)try{$.current.innerHTML="",new window.QRCode($.current,{text:`${location.origin}${o.viewerUrl}`,width:128,height:128})}catch(n){console.error("QR generation failed:",n)}};document.readyState==="complete"?requestAnimationFrame(()=>requestAnimationFrame(i)):window.addEventListener("load",i,{once:!0}),P("complete")}catch(t){console.error("Upload error:",t),x("Upload failed: "+(t.message||"Network error"))}finally{setTimeout(()=>{ee(!1),P("")},1e3)}}},te=async()=>{if(h){x(""),Z(!0);try{await re();let t=await de(q),{canvas:e,blob:o}=await ue(t,{clickPoint:z,overlay:O.current,displayImgEl:G.current}),i=URL.createObjectURL(o);j(i);let n=(h.name||"image").replace(/\.[^.]+$/,""),a=new File([o],`${n}-nobg.png`,{type:"image/png"});W(a),T(!1),M(null)}catch(t){console.error("Background removal failed:",t);let e=t&&t.message||"ONNX processing error";x("Background removal failed: "+e)}finally{Z(!1)}}};React.useEffect(()=>{let t=O.current,e=G.current;if(!t||!e)return;let o=t.parentElement;function i(){if(!o)return;let n=o.getBoundingClientRect(),a=Math.min(2,window.devicePixelRatio||1);t.width=Math.max(1,Math.floor(n.width*a)),t.height=Math.max(1,Math.floor(n.height*a)),t.style.width=n.width+"px",t.style.height=n.height+"px";let r=t.getContext("2d");r.setTransform(1,0,0,1,0,0),r.scale(a,a),r.clearRect(0,0,n.width,n.height)}return i(),window.addEventListener("resize",i),()=>window.removeEventListener("resize",i)},[q,E]),React.useEffect(()=>{let t=O.current;if(!t)return;let e=t.getContext("2d");function o(a){let r=t.getBoundingClientRect();return{x:a.clientX-r.left,y:a.clientY-r.top}}function i(a){let r=t.getBoundingClientRect(),m=Math.min(2,window.devicePixelRatio||1);e.save(),e.setTransform(1,0,0,1,0,0),e.scale(m,m),e.clearRect(0,0,r.width,r.height),a&&(e.beginPath(),e.arc(a.x,a.y,8,0,Math.PI*2),e.fillStyle="rgba(0,150,255,0.8)",e.fill(),e.lineWidth=2,e.strokeStyle="white",e.stroke()),e.restore()}function n(a){if(!E)return;let r=o(a);M(r),i(r),a.preventDefault()}return t.addEventListener("pointerdown",n),i(z),()=>{t.removeEventListener("pointerdown",n)}},[E,z]);function de(t){return new Promise((e,o)=>{let i=new Image;i.crossOrigin="anonymous",i.onload=()=>e(i),i.onerror=o,i.src=t})}async function ue(t,e){let i=Math.min(1,1280/Math.max(t.naturalWidth,t.naturalHeight)),n=Math.max(1,Math.round(t.naturalWidth*i)),a=Math.max(1,Math.round(t.naturalHeight*i)),r=document.createElement("canvas");r.width=n,r.height=a;let m=r.getContext("2d");m.drawImage(t,0,0,n,a);let s=320,p=document.createElement("canvas");p.width=s,p.height=s;let l=p.getContext("2d");l.drawImage(r,0,0,s,s);let c=l.getImageData(0,0,s,s),u=new Float32Array(3*s*s);for(let d=0;d<s;d++)for(let b=0;b<s;b++){let N=(d*s+b)*4,L=c.data[N]/255,ye=c.data[N+1]/255,Ne=c.data[N+2]/255,_=d*s+b;u[0*s*s+_]=L,u[1*s*s+_]=ye,u[2*s*s+_]=Ne}let g=window.ort,v=await me(),w={},k=v.inputNames[0];w[k]=new g.Tensor("float32",u,[1,3,s,s]);let C=await v.run(w),y=v.outputNames[0],I=C[y],R=I.dims,S=R[R.length-1],A=R[R.length-2],ge=I.data,D=new ImageData(S,A);for(let d=0;d<S*A;d++){let b=Math.max(0,Math.min(1,ge[d])),N=d*4,L=Math.round(b*255);D.data[N]=L,D.data[N+1]=L,D.data[N+2]=L,D.data[N+3]=255}let Q=document.createElement("canvas");Q.width=S,Q.height=A,Q.getContext("2d").putImageData(D,0,0);let X=document.createElement("canvas");X.width=n,X.height=a;let V=X.getContext("2d");V.imageSmoothingEnabled=!0,V.drawImage(Q,0,0,n,a);let fe=V.getImageData(0,0,n,a),ve=128,se=new Uint8ClampedArray(n*a);for(let d=0;d<n*a;d++)se[d]=fe.data[d*4]>=ve?1:0;let F=se,Y=e&&e.clickPoint?e.clickPoint:null;if(Y){let d=e.displayImgEl.getBoundingClientRect(),b=Math.round(Y.x/d.width*n),N=Math.round(Y.y/d.height*a);F=ne(F,n,a,b,N)}else F=ae(F,n,a);let we=pe(F,n,a,2),oe=m.getImageData(0,0,n,a);for(let d=0;d<n*a;d++)oe.data[d*4+3]=we[d];m.putImageData(oe,0,0);let he=await new Promise(d=>r.toBlob(d,"image/png"));return{canvas:r,blob:he}}let me=(()=>{let t=null;return function(){return t||(t=window.ort.InferenceSession.create("/models/u2netp.onnx",{executionProviders:["wasm"]}),t)}})();function ne(t,e,o,i,n){let a=(u,g)=>u>=0&&g>=0&&u<e&&g<o,r=(u,g)=>g*e+u;if(!a(i,n)||t[r(i,n)]===0)return ae(t,e,o);let m=new Uint8ClampedArray(e*o),s=new Int32Array(e*o),p=new Int32Array(e*o),l=0,c=0;for(s[c]=i,p[c]=n,c++,m[r(i,n)]=1;l<c;){let u=s[l],g=p[l];l++;for(let v=-1;v<=1;v++)for(let w=-1;w<=1;w++){if(w===0&&v===0)continue;let k=u+w,C=g+v;if(!a(k,C))continue;let y=r(k,C);t[y]&&!m[y]&&(m[y]=1,s[c]=k,p[c]=C,c++)}}return m}function ae(t,e,o){let i=(l,c)=>l>=0&&c>=0&&l<e&&c<o,n=(l,c)=>c*e+l,a=new Uint8Array(e*o),r=null,m=0,s=new Int32Array(e*o),p=new Int32Array(e*o);for(let l=0;l<o;l++)for(let c=0;c<e;c++){let u=n(c,l);if(!t[u]||a[u])continue;let g=0,v=0,w=0;for(s[v]=c,p[v]=l,v++,a[u]=1;g<v;){let k=s[g],C=p[g];g++,w++;for(let y=-1;y<=1;y++)for(let I=-1;I<=1;I++){if(I===0&&y===0)continue;let R=k+I,S=C+y;if(!i(R,S))continue;let A=n(R,S);!t[A]||a[A]||(a[A]=1,s[v]=R,p[v]=S,v++)}}w>m&&(m=w,r=[c,l])}return r?ne(t,e,o,r[0],r[1]):t}function pe(t,e,o,i){let n=new Uint8ClampedArray(e*o);for(let m=0;m<e*o;m++)n[m]=t[m]?255:0;if(i<=0)return n;let a=new Uint8ClampedArray(e*o),r=Math.max(1,i);for(let m=0;m<r;m++){for(let s=0;s<o;s++)for(let p=0;p<e;p++){let l=0,c=0;for(let u=-1;u<=1;u++){let g=p+u;g>=0&&g<e&&(l+=n[s*e+g],c++)}a[s*e+p]=l/c|0}for(let s=0;s<o;s++)for(let p=0;p<e;p++){let l=0,c=0;for(let u=-1;u<=1;u++){let g=s+u;g>=0&&g<o&&(l+=a[g*e+p],c++)}n[s*e+p]=l/c|0}}return n}return React.createElement("div",{className:"app"},React.createElement("div",{className:"landing"},React.createElement("div",{className:"card stack"},React.createElement("div",{className:"row-center"},React.createElement("h2",{style:{margin:0}},"WebAR Sticker Uploader")),React.createElement("div",{className:"row-center subtle"},"Upload an image, then scan the QR to open AR."),React.createElement("div",{className:"stack"},React.createElement("div",{className:"preview"},q?React.createElement(React.Fragment,null,React.createElement("img",{ref:G,src:q,alt:"Preview"}),E&&React.createElement("canvas",{ref:O,style:{position:"absolute",inset:0,touchAction:"none",cursor:"crosshair"}})):null),U&&React.createElement("div",{className:"upload-progress"},React.createElement("div",{className:"progress-bar"},React.createElement("div",{className:`progress-fill ${f}`})),React.createElement("div",{className:"progress-text"},f==="uploading"&&"Uploading image to server...",f==="processing"&&"Processing image and preparing storage...",f==="generating"&&"Generating QR code and viewer...",f==="finalizing"&&"Finalizing setup...",f==="complete"&&"\u2705 Upload complete! QR code ready."),React.createElement("div",{className:"progress-steps"},React.createElement("div",{className:`step ${f==="uploading"||f==="processing"||f==="generating"||f==="finalizing"||f==="complete"?"active":""}`},React.createElement("span",{className:"step-icon"},"\u{1F4E4}"),React.createElement("span",{className:"step-text"},"Upload")),React.createElement("div",{className:`step ${f==="processing"||f==="generating"||f==="finalizing"||f==="complete"?"active":""}`},React.createElement("span",{className:"step-icon"},"\u2699\uFE0F"),React.createElement("span",{className:"step-text"},"Process")),React.createElement("div",{className:`step ${f==="generating"||f==="finalizing"||f==="complete"?"active":""}`},React.createElement("span",{className:"step-icon"},"\u{1F517}"),React.createElement("span",{className:"step-text"},"Generate")),React.createElement("div",{className:`step ${f==="complete"?"active":""}`},React.createElement("span",{className:"step-icon"},"\u2705"),React.createElement("span",{className:"step-text"},"Complete")))),f==="complete"&&!U&&React.createElement("div",{className:"success-message"},React.createElement("div",{className:"success-icon"},"\u{1F389}"),React.createElement("div",{className:"success-text"},"Image uploaded successfully! Your AR sticker is ready.")),React.createElement("div",{className:"row-center"},React.createElement("label",{className:"btn",style:{cursor:"pointer"}},React.createElement("input",{type:"file",accept:"image/*",onChange:ce,style:{display:"none"},disabled:U}),"Choose Image"),E?React.createElement(React.Fragment,null,React.createElement("div",{className:"pill",style:{display:"flex",gap:8,alignItems:"center"}},React.createElement("span",null,"Tap image to choose subject")),React.createElement("button",{className:"btn",onClick:()=>M(null),disabled:!z},"Clear"),React.createElement("button",{className:"btn",onClick:te,disabled:B},B?"Applying...":"Apply"),React.createElement("button",{className:"btn",onClick:()=>{T(!1),M(null)}},"Cancel")):React.createElement(React.Fragment,null,React.createElement("button",{className:"btn",onClick:()=>{T(!0),M(null)},disabled:!h||U||!q},"Pick Subject"),React.createElement("button",{className:"btn",onClick:te,disabled:!h||B||U},B?"Removing...":"Remove Background")),React.createElement("button",{className:"primary",onClick:le,disabled:!h||U},U?"Uploading...":"Upload & Generate QR")),React.createElement("div",{className:"row-center subtle"},"Use HTTPS on mobile to allow camera."),K?React.createElement("div",{className:"row-center",style:{color:"#b00020",fontWeight:600}},K):null),React.createElement("div",{className:"spacer"}),React.createElement("div",{className:"results-section"},React.createElement("div",{className:"qr-container"},React.createElement("div",{className:"qr",ref:$})),H&&React.createElement("div",{className:"results-links"},React.createElement("a",{className:"btn primary",href:H.viewerUrl,target:"_blank",rel:"noreferrer"},"Open AR Viewer"),React.createElement("div",{className:"url-display"},React.createElement("span",{className:"url-label"},"Viewer URL:"),React.createElement("span",{className:"url-text"},location.origin,H.viewerUrl)))))),React.createElement("div",{className:"footer"},"Edit stickers only in the AR page."))}function ie(){let h=document.getElementById("root");if(!h)return;ReactDOM.createRoot(h).render(React.createElement(Re,null))}document.readyState==="complete"?requestAnimationFrame(()=>requestAnimationFrame(ie)):window.addEventListener("load",()=>requestAnimationFrame(()=>requestAnimationFrame(ie)),{once:!0});})();
